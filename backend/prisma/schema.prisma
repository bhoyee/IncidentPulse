generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  admin
  operator
  viewer
}

enum Severity {
  low
  medium
  high
  critical
}

enum IncidentStatus {
  open
  investigating
  monitoring
  resolved
}

enum StatusState {
  operational
  partial_outage
  major_outage
}

enum MaintenanceStatus {
  scheduled
  in_progress
  completed
  canceled
}

enum AuditAction {
  user_login
  user_created
  user_updated
  user_deleted
  incident_created
  incident_updated
  incident_resolved
  incident_investigating
  incident_monitoring
  incident_deleted
  maintenance_created
  maintenance_updated
  maintenance_canceled
}

model User {
  id           String    @id @default(uuid())
  name         String
  email        String    @unique
  role         Role      @default(viewer)
  passwordHash String
  teamRoles    String[]  @default([])
  isActive     Boolean   @default(true)
  incidents    Incident[] @relation("IncidentCreator")
  updates      IncidentUpdate[]
  attachments  IncidentAttachment[]
  assignments  Incident[] @relation("IncidentAssignee")
  maintenanceEvents MaintenanceEvent[] @relation("MaintenanceCreatedBy")
  auditLogs    AuditLog[] @relation("AuditActor")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Incident {
  id              String           @id @default(uuid())
  title           String
  severity        Severity         @default(medium)
  status          IncidentStatus   @default(open)
  description     String
  createdById     String
  createdBy       User             @relation("IncidentCreator", fields: [createdById], references: [id])
  assignedToId    String?
  assignedTo      User?            @relation("IncidentAssignee", fields: [assignedToId], references: [id])
  serviceId       String
  service         Service          @relation(fields: [serviceId], references: [id])
  firstResponseAt DateTime?
  resolvedAt      DateTime?
  rootCause       String?   @db.Text
  resolutionSummary String? @db.Text
  updates         IncidentUpdate[]
  attachments     IncidentAttachment[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  categories      String[]         @default([])
  impactScope     String?          @db.Text
  escalationNotifiedAt DateTime?

  @@index([status])
  @@index([severity])
  @@index([createdAt])
  @@index([assignedToId])
  @@index([serviceId])
}

model IncidentUpdate {
  id         String   @id @default(uuid())
  incidentId String
  incident   Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  authorId   String
  author     User     @relation(fields: [authorId], references: [id])
  message    String
  createdAt  DateTime @default(now())
  attachments IncidentAttachment[] @relation("UpdateAttachments")

  @@index([incidentId])
}

model StatusCache {
  id         String      @id @default(uuid())
  state      StatusState
  uptime24h  Float
  payload    Json
  updatedAt  DateTime    @updatedAt
  createdAt  DateTime    @default(now())
}

model IntegrationSettings {
  id               String   @id @default("global-integrations")
  slackWebhookUrl  String?
  telegramBotToken String?
  telegramChatId   String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Service {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  description String?
  incidents   Incident[]
  maintenance MaintenanceEvent[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model MaintenanceEvent {
  id            String            @id @default(uuid())
  title         String
  description   String?
  status        MaintenanceStatus @default(scheduled)
  startsAt      DateTime
  endsAt        DateTime
  appliesToAll  Boolean           @default(true)
  serviceId     String?
  service       Service?          @relation(fields: [serviceId], references: [id])
  createdById   String?
  createdBy     User?             @relation("MaintenanceCreatedBy", fields: [createdById], references: [id])
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([startsAt])
  @@index([endsAt])
  @@index([status])
}

model AuditLog {
  id          String      @id @default(uuid())
  action      AuditAction
  actorId     String?
  actor       User?       @relation("AuditActor", fields: [actorId], references: [id])
  actorEmail  String?
  actorName   String?
  targetType  String?
  targetId    String?
  metadata    Json?
  createdAt   DateTime    @default(now())

  @@index([createdAt])
  @@index([action])
  @@index([targetType, targetId])
}

model IncidentAttachment {
  id           String   @id @default(uuid())
  incidentId   String
  incident     Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  updateId     String?
  update       IncidentUpdate? @relation("UpdateAttachments", fields: [updateId], references: [id], onDelete: Cascade)
  uploadedById String
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])
  filename     String
  mimeType     String
  size         Int
  path         String
  createdAt    DateTime @default(now())

  @@index([incidentId])
  @@index([updateId])
}
