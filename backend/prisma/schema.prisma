generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  admin
  operator
  viewer
}

enum Severity {
  low
  medium
  high
  critical
}

enum IncidentStatus {
  open
  investigating
  monitoring
  resolved
}

enum StatusState {
  operational
  partial_outage
  major_outage
}

model User {
  id           String    @id @default(uuid())
  name         String
  email        String    @unique
  role         Role      @default(viewer)
  passwordHash String
  teamRoles    String[]  @default([])
  isActive     Boolean   @default(true)
  incidents    Incident[] @relation("IncidentCreator")
  updates      IncidentUpdate[]
  attachments  IncidentAttachment[]
  assignments  Incident[] @relation("IncidentAssignee")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Incident {
  id              String           @id @default(uuid())
  title           String
  severity        Severity         @default(medium)
  status          IncidentStatus   @default(open)
  description     String
  createdById     String
  createdBy       User             @relation("IncidentCreator", fields: [createdById], references: [id])
  assignedToId    String?
  assignedTo      User?            @relation("IncidentAssignee", fields: [assignedToId], references: [id])
  serviceId       String
  service         Service          @relation(fields: [serviceId], references: [id])
  firstResponseAt DateTime?
  resolvedAt      DateTime?
  updates         IncidentUpdate[]
  attachments     IncidentAttachment[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  categories      String[]         @default([])
  impactScope     String?          @db.Text
  escalationNotifiedAt DateTime?

  @@index([status])
  @@index([severity])
  @@index([createdAt])
  @@index([assignedToId])
  @@index([serviceId])
}

model IncidentUpdate {
  id         String   @id @default(uuid())
  incidentId String
  incident   Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  authorId   String
  author     User     @relation(fields: [authorId], references: [id])
  message    String
  createdAt  DateTime @default(now())
  attachments IncidentAttachment[] @relation("UpdateAttachments")

  @@index([incidentId])
}

model StatusCache {
  id         String      @id @default(uuid())
  state      StatusState
  uptime24h  Float
  payload    Json
  updatedAt  DateTime    @updatedAt
  createdAt  DateTime    @default(now())
}

model IntegrationSettings {
  id               String   @id @default("global-integrations")
  slackWebhookUrl  String?
  telegramBotToken String?
  telegramChatId   String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Service {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  description String?
  incidents   Incident[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model IncidentAttachment {
  id           String   @id @default(uuid())
  incidentId   String
  incident     Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  updateId     String?
  update       IncidentUpdate? @relation("UpdateAttachments", fields: [updateId], references: [id], onDelete: Cascade)
  uploadedById String
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])
  filename     String
  mimeType     String
  size         Int
  path         String
  createdAt    DateTime @default(now())

  @@index([incidentId])
  @@index([updateId])
}
